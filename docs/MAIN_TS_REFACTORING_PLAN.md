# План рефакторинга main.ts

## Анализ текущего состояния

### Размер: 471 строка
### Глобальные переменные: 2
- `globalTimerService`
- `globalDatabase`

### Функции setGlobal*: 2
- `setGlobalServices()`
- `setGlobalDatabaseForMain()`

---

## Структура файла

### Вспомогательные функции (строки 31-108):
1. **getOrCreateUser()** (строки 31-52)
   - Используется в other-actions, schedule-feeding
   - Нужно оставить как экспорт
   - **Действие:** Обновить для использования ctx

2. **autoDetectAndSaveTimezone()** (строки 81-108)
   - Локальная функция
   - **Действие:** Обновить сигнатуру для ctx

### Обработчики (строки 55-468):

#### 1. Scene.enter (строки 55-78) - ПРОСТОЙ
- Логика входа
- Проверка session.justFed
- **Действие:** Оставить как есть, добавить registerCommonNavigationHandlers

#### 2. "Другие действия" (строки 110-113) - ПРОСТОЙ
- Навигация
- **Действие:** Оставить как есть

#### 3. "Когда следующее кормление?" (строки 116-184) - СРЕДНИЙ
- Использует globalTimerService, globalDatabase
- Логика отображения времени
- **Действие:** Заменить на ctx.timerService, ctx.database

#### 4. "Собачка поел" (строки 187-315) - СЛОЖНЫЙ
- Самый большой обработчик (128 строк)
- Логика кормления, таймеры, уведомления
- **Действие:** 
  - Заменить globals на ctx
  - Использовать MessageBuilder.feedingNotification()
  - Вынести форматирование интервала в утилиту

#### 5. "Завершить кормления" (строки 318-374) - ДУБЛИРОВАНИЕ
- **ПРОБЛЕМА:** Точно такой же код есть в other-actions.ts!
- **Действие:** УДАЛИТЬ (дублирование)

#### 6. Команда /status (строки 377-443) - СРЕДНИЙ
- Использует globalTimerService, globalDatabase
- Форматирование статуса
- **Действие:** Заменить на ctx, использовать UI_TEXTS

#### 7. Навигационные обработчики (строки 445-468) - ПРОСТОЙ
- /home, "Уточнить детали", "На главную", неизвестные команды
- **Действие:** Часть заменить registerCommonNavigationHandlers

---

## План рефакторинга

### Шаг 1: Подготовка
- [x] Добавить вспомогательные функции в UI_TEXTS
- [x] Создать функцию форматирования интервала в time-utils

### Шаг 2: Удаление дублирования
- [ ] Удалить обработчик "Завершить кормления" (есть в other-actions)

### Шаг 3: Замена globals на ctx
- [ ] Убрать globalTimerService, globalDatabase
- [ ] Убрать setGlobalServices(), setGlobalDatabaseForMain()
- [ ] Обновить getOrCreateUser() для ctx
- [ ] Обновить autoDetectAndSaveTimezone() для ctx
- [ ] Заменить все использования globals на ctx

### Шаг 4: Применение новой архитектуры
- [ ] Добавить registerCommonNavigationHandlers()
- [ ] Использовать UI_TEXTS везде
- [ ] Использовать MessageFormatter для ошибок
- [ ] Использовать MessageBuilder для уведомлений

### Шаг 5: Оптимизация
- [ ] Вынести форматирование интервала в утилиту
- [ ] Упростить логику форматирования времени
- [ ] Улучшить читаемость

---

## Оценка

### Сложность: Высокая
- Самая большая сцена (471 строка)
- Много бизнес-логики
- Дублирование с other-actions

### Риски:
- ⚠️ Можно сломать логику кормления (критическая функция)
- ⚠️ Много зависимостей от timerService
- ⚠️ Сложное форматирование сообщений

### Время: 2-3 часа
- Анализ: 30 мин ✅
- Рефакторинг: 1.5-2 часа
- Тестирование: 30 мин

---

## Стратегия: Пошаговая миграция

1. Сначала простые изменения (навигация)
2. Потом замена globals
3. Удаление дублирования
4. Оптимизация последней
5. Проверка компиляции после каждого шага

**Начинаем!**
